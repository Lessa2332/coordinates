 <!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="./manifest.json">
    <title>AR –°–≤—ñ—Ç –ó–û–® ‚Ññ6</title>
    
    <!-- –û–Ω–æ–≤–ª–µ–Ω—ñ –≤–µ—Ä—Å—ñ—ó –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
        :root {
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        html, body { 
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            background: #000; 
            font-family: var(--ui-font);
            -webkit-font-smoothing: antialiased;
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }

        /* –í—ñ–¥–µ–æ–ø–æ—Ç—ñ–∫ AR.js –Ω–∞ –∑–∞–¥–Ω—å–æ–º—É –ø–ª–∞–Ω—ñ */
        .arjs-video, video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            z-index: 1 !important;
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç-–∫–∞–º–µ—Ä–∏ */
        }

        /* Canvas A-Frame –ø–æ–≤–µ—Ä—Ö –≤—ñ–¥–µ–æ */
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 2 !important;
            touch-action: none;
        }

        /* UI –µ–ª–µ–º–µ–Ω—Ç–∏ –ø–æ–≤–µ—Ä—Ö –≤—Å—å–æ–≥–æ */
        .guide-ui, .controls, .btn {
            z-index: 1000 !important;
            position: fixed;
        }

        .guide-ui {
            top: env(safe-area-inset-top, 20px);
            left: 50%; 
            transform: translateX(-50%);
            width: 85%; 
            max-width: 450px;
            background: rgba(255, 255, 255, 0.92); 
            color: #1a1a1a;
            padding: 15px 20px; 
            border-radius: 24px; 
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            pointer-events: none;
        }

        #instruction {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        #distance-badge {
            display: inline-block;
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .controls {
            bottom: env(safe-area-inset-bottom, 30px);
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            pointer-events: auto;
        }

        .btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 14px 24px;
            border-radius: 18px;
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s;
        }
        
        .btn:active { transform: scale(0.98); }

        .arjs-loader {
            background: #4facfe;
            color: white;
            font-weight: bold;
            z-index: 2000 !important;
        }

        @media screen and (max-height: 700px) {
            #instruction { font-size: 16px; }
            .btn { padding: 10px 18px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <!-- –õ–æ–∞–¥–µ—Ä, —â–æ –∑–Ω–∏–∫–∞—î –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó -->
    <div class="arjs-loader" id="loader" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 40px;border-radius:16px;z-index:3000;">
        üõ∞Ô∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è AR...
    </div>

    <div class="guide-ui" id="ui">
        <div id="instruction">–î–æ–∑–≤–æ–ª—å—Ç–µ GPS —Ç–∞ –∫–∞–º–µ—Ä—É üõ∞Ô∏è</div>
        <div id="distance-badge">–ü–æ—à—É–∫...</div>
    </div>

    <div class="controls">
        <button id="quiz-btn" class="btn">üìù –ü–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç</button>
        <button id="sound-btn" class="btn">üéµ –ó–≤—É–∫</button>
        <button id="refresh-btn" class="btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    </div>

    <!-- –û–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ü–µ–Ω–∞: gps-new-camera, gps-projected-entity, –±–µ–∑ look-controls -->
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; trackingMethod: best available;"
        renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true; colorManagement: true; physicallyCorrectLights: true;"
        keyboard-shortcuts="enabled: false"
        style="background: transparent;"
    >
        <a-assets>
            <img id="earth-texture" src="./earth.jpg" crossorigin="anonymous">
            <audio id="bg-music" src="./bg-music.mp3" preload="auto" loop crossorigin="anonymous"></audio>
        </a-assets>

        <!-- –ü–ª–∞–Ω–µ—Ç–∞: —Å–ø–æ—á–∞—Ç–∫—É –Ω–µ–≤–∏–¥–∏–º–∞, –ø–æ–∫–∏ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –≤—ñ–¥—Å—Ç–∞–Ω—å -->
        <a-entity id="ar-world" gps-projected-entity="latitude: 46.297082; longitude: 30.650495;">
            
            <a-sphere 
                id="main-planet"
                position="0 1.2 0" 
                radius="2" 
                src="#earth-texture"
                material="side: double;"
                visible="false"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 25000; easing: linear; enabled: true;">
            </a-sphere>

            <a-entity id="quiz-3d" position="0 1.5 -4" visible="false">
                <a-plane width="3.5" height="2.5" color="#ffffff" opacity="0.95" border-radius="0.2" material="side: double;"></a-plane>
                <a-text value="–Ø–∫—ñ –æ–ø–∞–¥–∏ \n—É –≤–∏–≥–ª—è–¥—ñ –∫—É–ª—å–æ–∫?" color="#1a1a1a" align="center" position="0 0.6 0.05" width="3" wrap-count="25"></a-text>
                
                <a-entity position="0 -0.1 0.05" class="clickable" onclick="check(1)" cursor-listener>
                    <a-plane width="2.8" height="0.45" color="#4facfe" material="side: double;"></a-plane>
                    <a-text value="–ì—Ä–∞–¥" align="center" width="2.8" color="white" position="0 0 0.02"></a-text>
                </a-entity>
                <a-entity position="0 -0.65 0.05" class="clickable" onclick="check(0)" cursor-listener>
                    <a-plane width="2.8" height="0.45" color="#f0f0f0" material="side: double;"></a-plane>
                    <a-text value="–°–Ω—ñ–≥" align="center" width="2.8" color="#333" position="0 0 0.02"></a-text>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- –ö–∞–º–µ—Ä–∞: –±–µ–∑ look-controls, –∑ rotation-reader -->
        <a-camera 
            id="ar-camera"
            gps-new-camera="minDistance: 1;" 
            rotation-reader
            look-controls="enabled: false">
            <a-cursor 
                color="#4facfe" 
                scale="0.6 0.6 0.6"
                animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.6 0.6 0.6; to: 0.3 0.3 0.3">
            </a-cursor>
        </a-camera>
    </a-scene>

    <script>
        // ‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø: –≤–∏–º–∫–Ω—ñ—Ç—å –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è!
        const DEV_MODE = true; // ‚Üê –ó–º—ñ–Ω—ñ—Ç—å –Ω–∞ false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
        const TARGET_LAT = 46.297082;
        const TARGET_LON = 30.650495;
        const MAX_DISTANCE = 30; // –º–µ—Ç—Ä–∏

        const instruction = document.getElementById('instruction');
        const badge = document.getElementById('distance-badge');
        const quiz3d = document.getElementById('quiz-3d');
        const planet = document.getElementById('main-planet');
        const bgMusic = document.getElementById('bg-music');
        const loader = document.getElementById('loader');
        const arScene = document.getElementById('ar-scene');
        const arCamera = document.getElementById('ar-camera');
        
        let isSoundEnabled = false;
        let userPosition = null;
        let gpsWatcher = null;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
        arScene.addEventListener('loaded', () => {
            console.log('üé¨ AR Scene loaded');
            
            // –•–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä
            setTimeout(() => {
                loader.style.display = 'none';
            }, 1500);

            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–∏–º—É–ª—è—Ü—ñ—é GPS —Ç—ñ–ª—å–∫–∏ –¥–ª—è DEV_MODE
            if (DEV_MODE) {
                console.log('üß™ DEV MODE: GPS —Å–∏–º—É–ª—è—Ü—ñ—è —É–≤—ñ–º–∫–Ω–µ–Ω–∞');
                arCamera.setAttribute('gps-new-camera', `simulateLatitude: ${TARGET_LAT}; simulateLongitude: ${TARGET_LON}; minDistance: 1;`);
                // –£ –¥–µ–≤-—Ä–µ–∂–∏–º—ñ –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ –ø–ª–∞–Ω–µ—Ç—É –¥–ª—è —Ç–µ—Å—Ç—É
                updatePlanetVisibility(5); 
            } else {
                console.log('üåç PROD MODE: —á–µ–∫–∞—î–º–æ —Ä–µ–∞–ª—å–Ω–∏–π GPS');
                instruction.innerText = "üì° –ü–æ—à—É–∫ GPS...";
                requestGPS();
            }
        });

        // –ó–∞–ø–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ GPS
        function requestGPS() {
            if (!navigator.geolocation) {
                instruction.innerText = "‚ùå GPS –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è";
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    console.log('üìç GPS –æ—Ç—Ä–∏–º–∞–Ω–æ:', userPosition);
                    instruction.innerText = "‚úÖ GPS –∑–Ω–∞–π–¥–µ–Ω–æ. –ô–¥—ñ—Ç—å –¥–æ —à–∫–æ–ª–∏ üè´";
                    
                    // –ü–æ—á–∏–Ω–∞—î–º–æ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é
                    gpsWatcher = navigator.geolocation.watchPosition(updatePosition, 
                        (err) => {
                            console.error('GPS error:', err);
                            instruction.innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ GPS: " + err.message;
                        }, 
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                },
                (err) => {
                    console.error('GPS permission denied:', err);
                    instruction.innerText = "üîê –î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ GPS –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö";
                    badge.style.background = "#ff6b6b";
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ
        function updatePosition(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const dist = calculateDistance(lat, lon, TARGET_LAT, TARGET_LON);
            updatePlanetVisibility(dist);
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ –ø–ª–∞–Ω–µ—Ç–∏ —Ç–∞ UI
        function updatePlanetVisibility(distance) {
            const dist = Math.round(distance);
            badge.innerText = `${dist} –º`;
            
            if (distance <= MAX_DISTANCE) {
                // –í –º–µ–∂–∞—Ö –∑–æ–Ω–∏: –ø–æ–∫–∞–∑—É—î–º–æ –ø–ª–∞–Ω–µ—Ç—É
                planet.setAttribute('visible', 'true');
                instruction.innerText = "üåç –ü–ª–∞–Ω–µ—Ç–∞ –ø–æ—Ä—É—á! –î–∏–≤–∏—Å—å –Ω–∞–≤–∫–æ–ª–æ";
                badge.style.background = "#4ade80";
            } else {
                // –ü–æ–∑–∞ –∑–æ–Ω–æ—é: —Ö–æ–≤–∞—î–º–æ –ø–ª–∞–Ω–µ—Ç—É
                planet.setAttribute('visible', 'false');
                instruction.innerText = "üèÉ –ô–¥—ñ—Ç—å –±–ª–∏–∂—á–µ –¥–æ —à–∫–æ–ª–∏";
                badge.style.background = "#ff6b6b";
            }
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó –≤—ñ–¥ AR.js (—Ä–µ–∑–µ—Ä–≤–Ω–∏–π)
        window.addEventListener('gps-entity-place-update-position', (e) => {
            if (DEV_MODE) return; // –£ –¥–µ–≤-—Ä–µ–∂–∏–º—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–ª–∞—Å–Ω—É –ª–æ–≥—ñ–∫—É
            const dist = Math.round(e.detail.distance);
            updatePlanetVisibility(dist);
        });

        // –§–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å—ñ–≤ –¥–ª—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // —Ä–∞–¥—ñ—É—Å –ó–µ–º–ª—ñ –≤ –º–µ—Ç—Ä–∞—Ö
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // –ö–Ω–æ–ø–∫–∞ –≤—ñ–∫—Ç–æ—Ä–∏–Ω–∏
        document.getElementById('quiz-btn').onclick = () => {
            const isVisible = quiz3d.getAttribute('visible');
            quiz3d.setAttribute('visible', !isVisible);
            if (!isVisible) {
                quiz3d.setAttribute('animation__appear', 'property: scale; from: 0.1 0.1 0.1; to: 1 1 1; dur: 300; easing: easeOutQuad');
            }
        };

        // –ó–≤—É–∫ + iOS —Ñ—ñ–∫—Å
        const unlockAudio = () => {
            if (!isSoundEnabled) {
                bgMusic.play().then(() => {
                    isSoundEnabled = true;
                    document.getElementById('sound-btn').innerText = "üîá –í–∏–º–∫–Ω—É—Ç–∏";
                }).catch(err => {
                    console.log('üîá –ê—É–¥—ñ–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø–æ–ª—ñ—Ç–∏–∫–æ—é –±—Ä–∞—É–∑–µ—Ä–∞:', err);
                });
            } else {
                bgMusic.pause();
                isSoundEnabled = false;
                document.getElementById('sound-btn').innerText = "üéµ –ó–≤—É–∫";
            }
        };

        document.getElementById('sound-btn').onclick = unlockAudio;
        
        // –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –¥–æ—Ç–∏–∫—É
        document.body.addEventListener('touchstart', () => {
            if (!isSoundEnabled && bgMusic.paused) {
                bgMusic.volume = 0.1;
                bgMusic.play().then(() => {
                    bgMusic.pause();
                    bgMusic.volume = 0.7;
                }).catch(() => {});
            }
        }, { once: true });

        // –ö–Ω–æ–ø–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó
        document.getElementById('refresh-btn').onclick = () => {
            if (gpsWatcher) navigator.geolocation.clearWatch(gpsWatcher);
            requestGPS();
            instruction.innerText = "üîÑ –û–Ω–æ–≤–ª—é—î–º–æ GPS...";
        };

        function check(isCorrect) {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: ${isCorrect ? '#4ade80' : '#f87171'}; color: white;
                padding: 15px 25px; border-radius: 16px; font-weight: 600; font-size: 18px;
                z-index: 2000; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                animation: fadeOut 2s forwards;
            `;
            msg.innerText = isCorrect ? "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¶–µ –ì—Ä–∞–¥." : "‚ùå –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!";
            document.body.appendChild(msg);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeOut {
                    0%, 70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                }
            `;
            document.head.appendChild(style);
            setTimeout(() => msg.remove(), 2000);
        }

        // iOS DeviceOrientation permission
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.body.addEventListener('click', () => {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            console.log('‚úÖ –î–æ–∑–≤—ñ–ª –Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—é –æ—Ç—Ä–∏–º–∞–Ω–æ');
                        }
                    })
                    .catch(console.error);
            }, { once: true });
        }

        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        window.addEventListener('error', (e) => {
            if (e.target.tagName === 'IMG' || e.target.tagName === 'AUDIO') {
                console.warn('‚ö†Ô∏è –ù–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', e.target.src);
                if (!DEV_MODE) {
                    instruction.innerText = "‚ö†Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è";
                }
            }
        }, true);

        // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ø–æ–¥–≤—ñ–π–Ω–∏–π —Ç–∞–ø –¥–ª—è –ø–æ–∫–∞–∑—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
        let lastTap = 0;
        document.body.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTap <= 300) {
                console.log('üîç DIAG INFO:', {
                    DEV_MODE,
                    userPosition,
                    planetVisible: planet.getAttribute('visible'),
                    video: document.querySelector('video')?.videoWidth
                });
                instruction.innerText = "üîç Diag: " + (planet.getAttribute('visible') ? "PLANETA ON" : "PLANETA OFF");
                setTimeout(() => {
                    instruction.innerText = userPosition ? "‚úÖ GPS OK" : "üì° GPS...";
                }, 2000);
            }
            lastTap = now;
        });
    </script>
</body>
</html>
