
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR –°–≤—ñ—Ç –ó–û–® ‚Ññ6 ‚Äì –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ñ –æ–ø–∞–¥–∏</title>
    
    <!-- –ú–∞–Ω—ñ—Ñ–µ—Å—Ç –¥–ª—è PWA -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- –°—Ç–∞–±—ñ–ª—å–Ω—ñ –≤–µ—Ä—Å—ñ—ó A-Frame —Ç–∞ AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
        }
        .ui-panel {
            position: fixed;
            top: env(safe-area-inset-top, 16px);
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 440px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            color: #111;
            padding: 16px 20px;
            border-radius: 32px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 1000;
            pointer-events: none;
        }
        #instruction {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 6px;
        }
        #distance-badge {
            display: inline-block;
            background: #4facfe;
            color: white;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .controls {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 24px);
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            z-index: 1000;
            pointer-events: none;
            padding: 0 8px;
        }
        .btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 12px 16px;
            border-radius: 28px;
            font-weight: 700;
            font-size: 14px;
            color: #111;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 6px;
            pointer-events: auto;
            transition: transform 0.1s ease, background 0.2s;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.6);
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.96); }
        .btn.active {
            background: #4facfe;
            color: white;
        }
        .arjs-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a2a3a;
            color: white;
            font-weight: 600;
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .toast-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 16px 32px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 20px;
            z-index: 10000;
            box-shadow: 0 12px 30px black;
            backdrop-filter: blur(4px);
            border: 2px solid #4facfe;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        @media (max-width: 480px) {
            .btn { padding: 10px 12px; font-size: 13px; }
            #instruction { font-size: 16px; }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–∞–¥–µ—Ä AR.js -->
    <div class="arjs-loader" id="loader">üõ∞Ô∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR ...</div>

    <div class="ui-panel" id="uiPanel">
        <div id="instruction">üåç –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö GPS‚Ä¶</div>
        <div id="distance-badge">‚Äî –º</div>
    </div>

    <div class="controls">
        <button id="quizBtn" class="btn">üìã –¢–µ—Å—Ç (12)</button>
        <button id="soundBtn" class="btn">üîä –ó–≤—É–∫</button>
        <button id="refreshBtn" class="btn">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button id="camBtn" class="btn">üì∑ –¢–∏–ª–æ–≤–∞ –∫–∞–º–µ—Ä–∞</button>
        <button id="photoBtn" class="btn">üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
    </div>

    <!-- A-Frame AR scene -->
    <a-scene
        id="scene"
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; videoTexture: true;"
        renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true; precision: medium; preserveDrawingBuffer: true;"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;"
    >
        <a-assets>
            <!-- –õ–æ–∫–∞–ª—å–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞ –ó–µ–º–ª—ñ -->
            <img id="earthTexture" src="./earth.jpg" crossorigin="anonymous">
            <!-- –õ–æ–∫–∞–ª—å–Ω–∏–π –∞—É–¥—ñ–æ—Ñ–∞–π–ª (–±–µ–∑ CORS –ø—Ä–æ–±–ª–µ–º) -->
            <audio id="bgMusic" src="./bg-music.mp3" preload="auto" loop crossorigin="anonymous"></audio>
        </a-assets>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–∞–Ω–µ—Ç–∏, –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —à–∫–æ–ª–∏ -->
        <a-entity
            id="planetContainer"
            gps-entity-place="latitude: 46.297082; longitude: 30.650495;"
            position="0 4 0"   <!-- —Ü–µ–Ω—Ç—Ä –Ω–∞ –≤–∏—Å–æ—Ç—ñ 4 –º (–ø–ª–∞–Ω–µ—Ç–∞ —Å—Ç–æ—è—Ç–∏–º–µ –Ω–∞ –∑–µ–º–ª—ñ) -->
        >
            <!-- –°–∞–º–∞ –ø–ª–∞–Ω–µ—Ç–∞ (–∫—É–ª—è) –∑—ñ –∑–±—ñ–ª—å—à–µ–Ω–∏–º —Ä–∞–¥—ñ—É—Å–æ–º -->
            <a-sphere
                id="planet"
                radius="4"
                src="#earthTexture"
                material="shader: flat;"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear"
                visible="false"
            ></a-sphere>

            <!-- 3D-–≤—ñ–∫—Ç–æ—Ä–∏–Ω–∞ (—Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∞ –≤—ñ–¥–Ω–æ—Å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –ø–ª–∞–Ω–µ—Ç–∏) -->
            <a-entity id="quizContainer" position="4 3 -2" scale="0.9 0.9 0.9" visible="false">
                <a-plane width="4.2" height="3.5" color="#ffffff" opacity="0.95" material="side: double; transparent: true" position="0 0 -0.1"></a-plane>
                <a-text id="questionText" value="–ó–∞–ø–∏—Ç–∞–Ω–Ω—è 1/12" color="#111" align="center" position="0 1.4 0" width="3.8" wrap-count="20" baseline="top" font="roboto"></a-text>
                <!-- –ö–Ω–æ–ø–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π (–∫–ª–∞—Å clickable –¥–ª—è –∫—É—Ä—Å–æ—Ä–∞) -->
                <a-entity id="answerA" class="clickable" position="-0.9 0.3 0" scale="1 1 1" onclick="handleAnswer(0)">
                    <a-plane width="1.9" height="0.7" color="#4facfe" material="side: double; transparent: true" radius="0.15"></a-plane>
                    <a-text id="answerAText" value="–í–∞—Ä—ñ–∞–Ω—Ç –ê" color="white" align="center" position="0 0 0.05" width="1.8"></a-text>
                </a-entity>
                <a-entity id="answerB" class="clickable" position="0.9 0.3 0" onclick="handleAnswer(1)">
                    <a-plane width="1.9" height="0.7" color="#4facfe" material="side: double; transparent: true" radius="0.15"></a-plane>
                    <a-text id="answerBText" value="–í–∞—Ä—ñ–∞–Ω—Ç –ë" color="white" align="center" position="0 0 0.05" width="1.8"></a-text>
                </a-entity>
                <!-- –ö–Ω–æ–ø–∫–∞ "–î–∞–ª—ñ" (–∫–ª–∞—Å clickable) -->
                <a-entity id="nextBtn" class="clickable" position="0 -0.9 0" visible="false" onclick="nextQuestion()">
                    <a-plane width="1.5" height="0.6" color="#ffaa00" material="side: double;" radius="0.2"></a-plane>
                    <a-text value="‚ñ∂ –î–∞–ª—ñ" color="white" align="center" position="0 0 0.05" width="1.4"></a-text>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- –ö–∞–º–µ—Ä–∞ –∑ GPS —Ç–∞ –∫—É—Ä—Å–æ—Ä–æ–º (raycaster –æ–±–º–µ–∂–µ–Ω–æ –∫–ª–∞—Å–æ–º clickable) -->
        <a-camera id="camera" gps-camera="minDistance: 1; maxDistance: 500;" rotation-reader>
            <a-cursor color="#4facfe" scale="0.7 0.7 0.7" fuse="false" raycaster="objects: .clickable"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        (function() {
            // ======================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ö–ê–ú–ï–†–ò –ó–ê URL ========================
            const urlParams = new URLSearchParams(window.location.search);
            const facingMode = urlParams.get('facingMode') || 'environment';
            
            const scene = document.getElementById('scene');
            scene.setAttribute('arjs', `sourceType: webcam; debugUIEnabled: false; trackingMethod: best; videoTexture: true; facingMode: ${facingMode};`);

            const camBtn = document.getElementById('camBtn');
            camBtn.innerHTML = facingMode === 'environment' ? 'üì∑ –¢–∏–ª–æ–≤–∞ –∫–∞–º–µ—Ä–∞' : 'üì∑ –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞ –∫–∞–º–µ—Ä–∞';

            camBtn.addEventListener('click', () => {
                const newFacing = facingMode === 'environment' ? 'user' : 'environment';
                const url = new URL(window.location.href);
                url.searchParams.set('facingMode', newFacing);
                window.location.href = url.toString(); // –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            });

            // ======================== –Ü–ù–®–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ========================
            const DEV_MODE = false; // –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑ GPS
            const TARGET_LAT = 46.297082;
            const TARGET_LON = 30.650495;
            const MAX_DISTANCE = 30; // –º–µ—Ç—Ä—ñ–≤, –Ω–∞ —è–∫—ñ–π –ø–ª–∞–Ω–µ—Ç–∞ —Å—Ç–∞—î –≤–∏–¥–∏–º–æ—é

            // ======================== 12 –ó–ê–ü–ò–¢–ê–ù–¨ ========================
            const questions = [
                { q: "–Ø–∫—ñ –æ–ø–∞–¥–∏ –≤–∏–ø–∞–¥–∞—é—Ç—å —É –≤–∏–≥–ª—è–¥—ñ –∫—É–ª—å–æ–∫ –ª—å–æ–¥—É?", a: "–ì—Ä–∞–¥", b: "–°–Ω—ñ–≥", correct: 0 },
                { q: "–©–æ —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –ø—Ä–∏ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ü—ñ—ó –ø–∞—Ä–∏ –Ω–∞ —Ö–æ–ª–æ–¥–Ω—ñ–π –ø–æ–≤–µ—Ä—Ö–Ω—ñ –≤–ª—ñ—Ç–∫—É?", a: "–†–æ—Å–∞", b: "–Ü–Ω—ñ–π", correct: 0 },
                { q: "–°–Ω—ñ–≥ ‚Äî —Ü–µ...", a: "–õ—å–æ–¥—è–Ω—ñ –∫—Ä–∏—Å—Ç–∞–ª–∏–∫–∏", b: "–ó–∞–º–µ—Ä–∑–ª–∏–π –¥–æ—â", correct: 0 },
                { q: "–Ø–∫—ñ –æ–ø–∞–¥–∏ –≤–∏–ø–∞–¥–∞—é—Ç—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ –Ω–∞—Å–∏—á–µ–Ω–æ–≥–æ –ø–æ–≤—ñ—Ç—Ä—è?", a: "–¢—É–º–∞–Ω, —Ä–æ—Å–∞, —ñ–Ω—ñ–π", b: "–î–æ—â, —Å–Ω—ñ–≥, –≥—Ä–∞–¥", correct: 0 },
                { q: "–Ø–∫ –Ω–∞–∑–∏–≤–∞—é—Ç—å—Å—è —Ç–≤–µ—Ä–¥—ñ –Ω–µ–ø—Ä–æ–∑–æ—Ä—ñ –ª—å–æ–¥—è–Ω—ñ –∫—Ä—É–ø–∏–Ω–∫–∏?", a: "–ö—Ä—É–ø–∞", b: "–ì—Ä–∞–¥", correct: 0 },
                { q: "–ö–æ–ª–∏ –Ω–∞–π—á–∞—Å—Ç—ñ—à–µ –≤–∏–ø–∞–¥–∞—î –≥—Ä–∞–¥?", a: "–í–∑–∏–º–∫—É", b: "–£–ª—ñ—Ç–∫—É –ø—ñ–¥ —á–∞—Å –≥—Ä–æ–∑–∏", correct: 1 },
                { q: "–°—É–º—ñ—à –ø–∏–ª—É, –¥–∏–º—É –π —Ç—É–º–∞–Ω—É ‚Äî —Ü–µ...", a: "–°–µ—Ä–ø–∞–Ω–æ–∫", b: "–°–º–æ–≥", correct: 1 },
                { q: "–Ø–∫–µ —è–≤–∏—â–µ –∑–Ω–∞—á–Ω–æ –∑–º–µ–Ω—à—É—î –≤–∏–¥–∏–º—ñ—Å—Ç—å –∑—Ä–∞–Ω–∫—É?", a: "–¢—É–º–∞–Ω", b: "–†–æ—Å–∞", correct: 0 },
                { q: "–©–æ —î –ø—Ä–∏—á–∏–Ω–æ—é —É—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ—â—É?", a: "–ö–æ–Ω–¥–µ–Ω—Å–∞—Ü—ñ—è —ñ –∑–ª–∏—Ç—Ç—è –∫—Ä–∞–ø–µ–ª—å", b: "–ó–∞–º–µ—Ä–∑–∞–Ω–Ω—è –ø–∞—Ä–∏", correct: 0 },
                { q: "–Ø–∫—ñ –æ–ø–∞–¥–∏ –Ω–∞–ª–µ–∂–∞—Ç—å –¥–æ —Ç–≤–µ—Ä–¥–∏—Ö (–∑ —Ö–º–∞—Ä)?", a: "–°–Ω—ñ–≥, –≥—Ä–∞–¥, –∫—Ä—É–ø–∞", b: "–î–æ—â, —Ä–æ—Å–∞", correct: 0 },
                { q: "–Ü–Ω—ñ–π —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è, –∫–æ–ª–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤–µ—Ä—Ö–Ω—ñ...", a: "–í–∏—â–∞ 0¬∞C", b: "–ù–∏–∂—á–∞ 0¬∞C", correct: 1 },
                { q: "–ö–æ—Ä–æ—Ç–∫–æ—á–∞—Å–Ω—ñ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ –æ–ø–∞–¥–∏ –Ω–∞–∑–∏–≤–∞—é—Ç—å...", a: "–ó–ª–∏–≤–∞", b: "–ú—Ä—è–∫–∞", correct: 0 }
            ];

            let currentQuestionIndex = 0;
            let answered = false;
            let score = 0;

            // ======================== –ï–õ–ï–ú–ï–ù–¢–ò DOM ========================
            const instructionEl = document.getElementById('instruction');
            const distanceBadge = document.getElementById('distance-badge');
            const quizBtn = document.getElementById('quizBtn');
            const soundBtn = document.getElementById('soundBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const photoBtn = document.getElementById('photoBtn');
            const planet = document.getElementById('planet');
            const quizContainer = document.getElementById('quizContainer');
            const questionText = document.getElementById('questionText');
            const answerAText = document.getElementById('answerAText');
            const answerBText = document.getElementById('answerBText');
            const nextBtn = document.getElementById('nextBtn');
            const bgMusic = document.getElementById('bgMusic');

            let isSoundOn = false;

            // ======================== –§–£–ù–ö–¶–Ü–Ø –§–û–¢–û (–í–ò–ü–†–ê–í–õ–ï–ù–ê) ========================
            function takeScreenshot() {
                const canvas = scene.renderer?.domElement;
                if (!canvas) {
                    showToast('‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ canvas', false);
                    return;
                }

                // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                setTimeout(() => {
                    try {
                        // –°–ø—Ä–æ–±–∞ 1: toBlob (–∫—Ä–∞—â–µ –¥–ª—è –ø–∞–º'—è—Ç—ñ)
                        canvas.toBlob(blob => {
                            if (!blob) {
                                fallbackToDataURL();
                                return;
                            }
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `ar_selfie_${Date.now()}.png`;

                            if (link.download !== undefined) {
                                link.click();
                                showToast('‚úÖ –§–æ—Ç–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', true);
                            } else {
                                // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö ‚Äì —Å–ø—Ä–æ–±–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –∞–±–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏
                                if (navigator.share && navigator.canShare?.({ files: [new File([blob], 'photo.png', { type: 'image/png' })] })) {
                                    navigator.share({
                                        files: [new File([blob], 'ar_photo.png', { type: 'image/png' })],
                                        title: 'AR –§–æ—Ç–æ',
                                    }).catch(() => window.open(url, '_blank'));
                                } else {
                                    window.open(url, '_blank');
                                }
                            }
                            setTimeout(() => URL.revokeObjectURL(url), 1000);
                        }, 'image/png');
                    } catch (e) {
                        fallbackToDataURL();
                    }

                    function fallbackToDataURL() {
                        try {
                            const dataURL = canvas.toDataURL('image/png');
                            const link = document.createElement('a');
                            link.href = dataURL;
                            link.download = `ar_selfie_${Date.now()}.png`;
                            if (link.download !== undefined) {
                                link.click();
                            } else {
                                window.open(dataURL, '_blank');
                            }
                            showToast('‚úÖ –§–æ—Ç–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –º–µ—Ç–æ–¥)', true);
                        } catch (err) {
                            showToast('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ', false);
                        }
                    }
                }, 150);
            }

            photoBtn.addEventListener('click', takeScreenshot);

            // ======================== –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ========================
            function showToast(msg, isSuccess = true) {
                const toast = document.createElement('div');
                toast.className = 'toast-message';
                toast.style.background = isSuccess ? '#2e7d32' : '#c62828';
                toast.innerText = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 1500);
            }

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ –≤—ñ–¥ AR.js
            function updatePlanetVisibility(dist) {
                const rounded = Math.round(dist);
                distanceBadge.innerText = rounded + ' –º';
                if (dist <= MAX_DISTANCE) {
                    planet.setAttribute('visible', 'true');
                    instructionEl.innerText = 'üåç –ü–ª–∞–Ω–µ—Ç–∞ –ø–æ—Ä—É—á! –î–∏–≤–∏—Å—å –Ω–∞–≤–∫–æ–ª–æ';
                    distanceBadge.style.background = '#4ade80';
                } else {
                    planet.setAttribute('visible', 'false');
                    instructionEl.innerText = 'üèÉ –ù–∞–±–ª–∏–∑—å—Ç–µ—Å—å –¥–æ —à–∫–æ–ª–∏ (30 –º)';
                    distanceBadge.style.background = '#ff6b6b';
                }
            }

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –∑–≤—É–∫—É
            function toggleSound() {
                if (isSoundOn) {
                    bgMusic.pause();
                    soundBtn.innerHTML = 'üîä –ó–≤—É–∫';
                } else {
                    bgMusic.play().catch(e => {
                        console.warn('Audio play failed:', e);
                        showToast('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–µ —Ä–∞–∑ –¥–ª—è –∑–≤—É–∫—É', false);
                    });
                    soundBtn.innerHTML = 'üîá –í–∏–º–∫–Ω—É—Ç–∏';
                }
                isSoundOn = !isSoundOn;
            }

            // –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ –Ω–∞ iOS
            document.body.addEventListener('touchstart', function unlock() {
                if (!isSoundOn && bgMusic.paused) {
                    bgMusic.volume = 0.1;
                    bgMusic.play().then(() => {
                        bgMusic.pause();
                        bgMusic.volume = 0.5;
                    }).catch(() => {});
                }
                document.body.removeEventListener('touchstart', unlock);
            }, { once: true });

            // ======================== –õ–û–ì–Ü–ö–ê –í–Ü–ö–¢–û–†–ò–ù–ò ========================
            function showQuestion(index) {
                const q = questions[index];
                questionText.setAttribute('value', `${index+1}/12. ${q.q}`);
                answerAText.setAttribute('value', q.a);
                answerBText.setAttribute('value', q.b);
                answered = false;
                nextBtn.setAttribute('visible', 'false');
            }

            window.handleAnswer = function(selectedIdx) {
                if (answered) {
                    showToast('–í–∏ –≤–∂–µ –≤—ñ–¥–ø–æ–≤—ñ–ª–∏', false);
                    return;
                }
                const q = questions[currentQuestionIndex];
                const isCorrect = (selectedIdx === q.correct);
                if (isCorrect) {
                    showToast('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!', true);
                    score++;
                } else {
                    showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${q.correct === 0 ? q.a : q.b}`, false);
                }
                answered = true;
                nextBtn.setAttribute('visible', 'true');
            };

            window.nextQuestion = function() {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion(currentQuestionIndex);
                } else {
                    showToast(`üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ${score}/${questions.length}`, true);
                    quizContainer.setAttribute('visible', 'false');
                    quizBtn.classList.remove('active');
                    currentQuestionIndex = 0;
                    score = 0;
                }
            };

            quizBtn.addEventListener('click', () => {
                const visible = quizContainer.getAttribute('visible') === 'true';
                if (!visible) {
                    quizContainer.setAttribute('visible', 'true');
                    quizBtn.classList.add('active');
                    currentQuestionIndex = 0;
                    showQuestion(0);
                } else {
                    quizContainer.setAttribute('visible', 'false');
                    quizBtn.classList.remove('active');
                }
            });

            soundBtn.addEventListener('click', toggleSound);

            // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É ‚Äì –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î —Å—Ç–æ—Ä—ñ–Ω–∫—É
            refreshBtn.addEventListener('click', () => {
                window.location.reload();
            });

            // ======================== –°–õ–£–•–ê–ß–Ü –ü–û–î–Ü–ô AR.JS ========================
            // –ö–æ–ª–∏ AR.js –æ—Ç—Ä–∏–º—É—î –ø–æ–∑–∏—Ü—ñ—é GPS —ñ –æ–Ω–æ–≤–ª—é—î –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –æ–±'—î–∫—Ç–∞
            window.addEventListener('gps-entity-place-update-position', (e) => {
                if (DEV_MODE) return;
                const dist = e.detail.distance;
                if (dist) updatePlanetVisibility(dist);
            });

            // –ö–æ–ª–∏ –≤—ñ–¥–µ–æ –∑ –∫–∞–º–µ—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äì —Ö–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä
            window.addEventListener('arjs-video-loaded', () => {
                const loader = document.querySelector('.arjs-loader');
                if (loader) loader.style.display = 'none';
            });

            // ======================== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ========================
            window.addEventListener('load', () => {
                if (DEV_MODE) {
                    // –†–µ–∂–∏–º —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: –ø–æ–∫–∞–∑—É—î–º–æ –ø–ª–∞–Ω–µ—Ç—É –Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ 12 –º
                    updatePlanetVisibility(12);
                    instructionEl.innerText = 'üß™ –†–ï–ñ–ò–ú –¢–ï–°–¢–£ (–ø–ª–∞–Ω–µ—Ç–∞ –≤–∏–¥–∏–º–∞)';
                    // –•–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä –æ–¥—Ä–∞–∑—É
                    const loader = document.querySelector('.arjs-loader');
                    if (loader) loader.style.display = 'none';
                } else {
                    instructionEl.innerText = 'üåç –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö GPS‚Ä¶';
                }

                // –ó–∞–ø–∏—Ç –¥–æ–∑–≤–æ–ª—É –Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—é –¥–ª—è iOS
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    document.body.addEventListener('click', () => {
                        DeviceOrientationEvent.requestPermission().catch(console.warn);
                    }, { once: true });
                }

                // –Ø–∫—â–æ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ AR.js —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è ‚Äì —Ö–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä –ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
                setTimeout(() => {
                    const loader = document.querySelector('.arjs-loader');
                    if (loader) loader.style.display = 'none';
                }, 10000);
            });
        })();
    </script>
    <!-- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è Service Worker –¥–ª—è PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker error', err));
            });
        }
    </script>
</body>
</html>
