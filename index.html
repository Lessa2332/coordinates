<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="./manifest.json">
    <title>AR –°–≤—ñ—Ç –ó–û–® ‚Ññ6</title>
    
    <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –≤–∏–¥–∞–ª–µ–Ω–æ –ø—Ä–æ–±—ñ–ª–∏ –≤ URL -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ GPS-–≤–µ—Ä—Å—ñ—é AR.js –∑–∞–º—ñ—Å—Ç—å NFT -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        :root {
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        html, body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: var(--ui-font);
            -webkit-font-smoothing: antialiased;
            touch-action: none; /* ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        }

        .guide-ui {
            position: fixed; 
            top: env(safe-area-inset-top, 20px);
            left: 50%; 
            transform: translateX(-50%);
            width: 85%; 
            max-width: 450px;
            background: rgba(255, 255, 255, 0.92); 
            color: #1a1a1a;
            padding: 15px 20px; 
            border-radius: 24px; 
            text-align: center;
            z-index: 1000; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            pointer-events: none; /* ‚úÖ –©–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞–≤ –∫–ª—ñ–∫–∏ –ø–æ AR-—Å—Ü–µ–Ω—ñ */
        }

        #instruction {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        #distance-badge {
            display: inline-block;
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .controls {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 30px);
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 1000;
            pointer-events: auto; /* ‚úÖ –ö–Ω–æ–ø–∫–∏ –º–∞—é—Ç—å —Ä–µ–∞–≥—É–≤–∞—Ç–∏ –Ω–∞ –∫–ª—ñ–∫–∏ */
        }

        .btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 14px 24px;
            border-radius: 18px;
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .arjs-loader {
            background: #4facfe;
            color: white;
            font-weight: bold;
        }

        /* ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: @underline ‚Üí @media */
        @media screen and (max-height: 700px) {
            #instruction { font-size: 16px; }
            .btn { padding: 10px 18px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <div class="guide-ui" id="ui">
        <div id="instruction">–î–æ–∑–≤–æ–ª—å—Ç–µ GPS —Ç–∞ –∫–∞–º–µ—Ä—É üõ∞Ô∏è</div>
        <div id="distance-badge">–ü–æ—à—É–∫...</div>
    </div>

    <div class="controls">
        <button id="quiz-btn" class="btn">üìù –ü–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç</button>
        <button id="sound-btn" class="btn">üéµ –ó–≤—É–∫</button>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true; colorManagement: true;"
        renderer="physicallyCorrectLights: true;"
    >
        <a-assets>
            <!-- ‚úÖ –î–æ–¥–∞–Ω–æ crossorigin –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è CORS-–ø–æ–º–∏–ª–æ–∫ -->
            <img id="earth-texture" src="./earth.jpg" crossorigin="anonymous">
            <audio id="bg-music" src="./bg-music.mp3" preload="auto" loop crossorigin="anonymous"></audio>
        </a-assets>

        <a-entity id="ar-world" gps-entity-place="latitude: 46.297082; longitude: 30.650495;">
            
            <a-sphere 
                id="main-planet"
                position="0 1.2 0" 
                radius="2" 
                src="#earth-texture"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 25000; easing: linear"
                material="side: double;"> <!-- ‚úÖ –î–æ–¥–∞–Ω–æ side: double –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ -->
            </a-sphere>

            <a-entity id="quiz-3d" position="0 1.5 -4" visible="false"> <!-- ‚úÖ –ó–º—ñ–Ω–µ–Ω–æ –ø–æ–∑–∏—Ü—ñ—é –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ -->
                <a-plane width="3.5" height="2.5" color="#ffffff" opacity="0.95" border-radius="0.2" material="side: double;"></a-plane>
                <a-text value="–Ø–∫—ñ –æ–ø–∞–¥–∏ \n—É –≤–∏–≥–ª—è–¥—ñ –∫—É–ª—å–æ–∫?" color="#1a1a1a" align="center" position="0 0.6 0.05" width="3" wrap-count="25"></a-text>
                
                <a-entity position="0 -0.1 0.05" class="clickable" onclick="check(1)" cursor-listener>
                    <a-plane width="2.8" height="0.45" color="#4facfe" material="side: double;"></a-plane>
                    <a-text value="–ì—Ä–∞–¥" align="center" width="2.8" color="white" position="0 0 0.02"></a-text>
                </a-entity>
                <a-entity position="0 -0.65 0.05" class="clickable" onclick="check(0)" cursor-listener>
                    <a-plane width="2.8" height="0.45" color="#f0f0f0" material="side: double;"></a-plane>
                    <a-text value="–°–Ω—ñ–≥" align="center" width="2.8" color="#333" position="0 0 0.02"></a-text>
                </a-entity>
            </a-entity>
        </a-entity>

        <a-camera 
            gps-camera="simulateLatitude: 46.297082; simulateLongitude: 30.650495; minDistance: 1;" 
            rotation-reader
            look-controls-enabled="true"> <!-- ‚úÖ –î–æ–¥–∞–Ω–æ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
            <a-cursor 
                fuse="true" 
                fuse-timeout="800" <!-- ‚úÖ –ó–º–µ–Ω—à–µ–Ω–æ —á–∞—Å –¥–ª—è —à–≤–∏–¥—à–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó -->
                color="#4facfe" 
                scale="0.6 0.6 0.6"
                animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.6 0.6 0.6; to: 0.3 0.3 0.3">
            </a-cursor>
        </a-camera>
    </a-scene>

    <script>
        const instruction = document.getElementById('instruction');
        const badge = document.getElementById('distance-badge');
        const quiz3d = document.getElementById('quiz-3d');
        const bgMusic = document.getElementById('bg-music');
        let isSoundEnabled = false;

        // ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤—É –ø–æ–¥—ñ—ó: update-positon ‚Üí update-position
        window.addEventListener('gps-entity-place-update-position', (e) => {
            const dist = Math.round(e.detail.distance);
            if (dist > 30) {
                instruction.innerText = "–ô–¥—ñ—Ç—å –±–ª–∏–∂—á–µ –¥–æ —à–∫–æ–ª–∏ üè´";
                badge.innerText = `${dist} –º`;
                badge.style.background = "#ff6b6b";
            } else {
                instruction.innerText = "–î–∏–≤–∏—Å—å –Ω–∞–≤–∫–æ–ª–æ, –ø–ª–∞–Ω–µ—Ç–∞ –ø–æ—Ä—É—á! üåç";
                badge.innerText = "–í–∏ –Ω–∞ –º—ñ—Å—Ü—ñ";
                badge.style.background = "#4facfe";
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –≤—ñ–∫—Ç–æ—Ä–∏–Ω–∏
        document.getElementById('quiz-btn').onclick = () => {
            const isVisible = quiz3d.getAttribute('visible');
            quiz3d.setAttribute('visible', !isVisible);
            // ‚úÖ –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏
            if (!isVisible) {
                quiz3d.setAttribute('animation__appear', 'property: scale; from: 0.1 0.1 0.1; to: 1 1 1; dur: 300; easing: easeOutQuad');
            }
        };

        // ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑–≤—É–∫—É –¥–ª—è iOS/Android
        const unlockAudio = () => {
            if (!isSoundEnabled) {
                bgMusic.play().then(() => {
                    isSoundEnabled = true;
                    document.getElementById('sound-btn').innerText = "üîá –í–∏–º–∫–Ω—É—Ç–∏";
                }).catch(err => {
                    console.log('–ê—É–¥—ñ–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å (–ø–æ–ª—ñ—Ç–∏–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞):', err);
                    // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–æ–≤—É –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫–ª—ñ–∫—É
                });
            } else {
                bgMusic.pause();
                isSoundEnabled = false;
                document.getElementById('sound-btn').innerText = "üéµ –ó–≤—É–∫";
            }
        };

        document.getElementById('sound-btn').onclick = unlockAudio;
        
        // ‚úÖ –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –¥–æ—Ç–∏–∫—É –±—É–¥—å-–¥–µ (–¥–ª—è iOS)
        document.body.addEventListener('touchstart', () => {
            if (!isSoundEnabled && bgMusic.paused) {
                // –ù–µ –∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∞–ª–µ –≥–æ—Ç—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                bgMusic.volume = 0.1;
                bgMusic.play().then(() => {
                    bgMusic.pause();
                    bgMusic.volume = 0.7;
                }).catch(() => {});
            }
        }, { once: true });

        function check(isCorrect) {
            // ‚úÖ –ó–∞–º—ñ–Ω–µ–Ω–æ alert –Ω–∞ –±—ñ–ª—å—à –µ–ª–µ–≥–∞–Ω—Ç–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: ${isCorrect ? '#4ade80' : '#f87171'}; color: white;
                padding: 15px 25px; border-radius: 16px; font-weight: 600; font-size: 18px;
                z-index: 2000; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                animation: fadeOut 2s forwards;
            `;
            msg.innerText = isCorrect ? "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¶–µ –ì—Ä–∞–¥." : "‚ùå –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!";
            document.body.appendChild(msg);
            
            // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeOut {
                    0%, 70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => msg.remove(), 2000);
        }

        // ‚úÖ –ó–∞–ø–∏—Ç –¥–æ–∑–≤–æ–ª—ñ–≤ –¥–ª—è iOS (DeviceOrientation)
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.body.addEventListener('click', () => {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            console.log('–î–æ–∑–≤—ñ–ª –Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—é –æ—Ç—Ä–∏–º–∞–Ω–æ');
                        }
                    })
                    .catch(console.error);
            }, { once: true });
        }

        // ‚úÖ –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤
        window.addEventListener('error', (e) => {
            if (e.target.tagName === 'IMG' || e.target.tagName === 'AUDIO') {
                console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏:', e.target.src);
                instruction.innerText = "‚ö†Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É";
            }
        }, true);
    </script>
</body>
</html>
